name: CD - Deploy to EKS

on:
    push:
        branches: [ kubernetes-03-cd, main ]
    workflow_dispatch:

env:
    DB_SECRET_ARN: ${{ secrets.DB_SECRET_ARN }}
    AWS_REGION: us-east-1
    EKS_CLUSTER_NAME: garage-cluster
    ECR_REPOSITORY: garage-app

jobs:
    deploy:
        name: Deploy to EKS
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Configure AWS credentials
                uses: aws-actions/configure-aws-credentials@v4
                with:
                    aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                    aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                    aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
                    aws-region: ${{ env.AWS_REGION }}

            -   name: Login to Amazon ECR
                id: login-ecr
                uses: aws-actions/amazon-ecr-login@v2

            -   name: Build and push Docker image
                env:
                    ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
                    IMAGE_TAG: ${{ github.sha }}
                run: |
                    IMAGE_TAG=${GITHUB_SHA}

                    docker build -t $ECR_REPOSITORY:$IMAGE_TAG .
                    docker tag $ECR_REPOSITORY:$IMAGE_TAG \
                        964022050595.dkr.ecr.us-east-1.amazonaws.com/$ECR_REPOSITORY:$IMAGE_TAG

                    docker push \
                        964022050595.dkr.ecr.us-east-1.amazonaws.com/$ECR_REPOSITORY:$IMAGE_TAG

                    echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

            -   name: Update kubeconfig
                run: |
                    aws eks update-kubeconfig --region ${{ env.AWS_REGION }} --name ${{ env.EKS_CLUSTER_NAME }}

            # ðŸ” NOVO â€“ Buscar secret no Secrets Manager
            -   name: Get DB secret from AWS
                id: db-secret
                run: |
                    set -x
                    echo "DB_SECRET_ARN=$DB_SECRET_ARN"
                    SECRET=$(aws secretsmanager get-secret-value \
                      --secret-id $DB_SECRET_ARN \
                      --query SecretString \
                      --output text)

                    echo "DB_USER=$(echo $SECRET | jq -r .username)" >> $GITHUB_ENV
                    echo "DB_PASS=$(echo $SECRET | jq -r .password)" >> $GITHUB_ENV

            # ðŸ”„ NOVO â€“ Atualizar secret no Kubernetes
            -   name: Update K8s DB secret
                run: |
                    kubectl create secret generic db-credentials \
                      --from-literal=username=$DB_USER \
                      --from-literal=password=$DB_PASS \
                      --dry-run=client -o yaml | kubectl apply -f -

            -   name: Deploy to EKS
                run: |
                    sed "s|\${IMAGE_TAG}|$IMAGE_TAG|g" k8s/deployment.yaml > deploy.yaml

                    echo "========== DEPLOY.YAML =========="
                    cat deploy.yaml
                    echo "================================"
                    kubectl apply -f deploy.yaml

            -   name: Wait rollout
                run: |
                    kubectl rollout status deployment/garage-app --timeout=5m
